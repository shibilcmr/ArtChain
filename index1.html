<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>International Group Chat</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #e5ddd5;
      margin: 0;
      display: flex;
      height: 100vh;
      justify-content: center;
      align-items: center;
    }

    .chat-container {
      width: 100%;
      max-width: 800px;
      height: 90vh;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .header {
      height: 60px;
      background: #075e54;
      color: #fff;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h2 {
      margin: 0;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #e5ddd5 url('https://web.whatsapp.com/img/bg-chat-tile-light_686b996410247c8b938ddf6a867c5df7.png');
      background-repeat: repeat;
    }

    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      max-width: 70%;
      word-wrap: break-word;
    }

    .message.sent {
      background: #dcf8c6;
      margin-left: auto;
    }

    .message.received {
      background: #fff;
    }

    .input-container {
      display: flex;
      padding: 10px;
      background: #f0f0f0;
    }

    .input-container input {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 20px;
      margin-right: 10px;
    }

    .input-container button {
      background: #075e54;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
    }

    @media (max-width: 600px) {
      .chat-container {
        height: 100vh;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="header">
      <h2>International Group Chat</h2>
    </div>
    <div class="messages" id="messages"></div>
    <form class="input-container" id="send-message">
      <input id="chat-txt" type="text" placeholder="Type a message..." />
      <button type="submit">Send</button>
    </form>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
  <script>
    // You need to create a Firebase project and replace this with your own config
    // Go to https://console.firebase.google.com/, create a project, add Realtime Database in test mode
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY_HERE",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let ip = 'unknown';

    fetch('https://api.ipify.org?format=json')
      .then(response => response.json())
      .then(data => ip = data.ip)
      .catch(error => console.error('Error fetching IP:', error));

    const form = document.getElementById("send-message");
    const input = document.getElementById("chat-txt");
    const messagesDiv = document.getElementById("messages");

    form.addEventListener("submit", e => {
      e.preventDefault();
      const message = input.value.trim();
      if (message === '') return;

      const words = message.split(/\s+/).length;
      if (!checkWordLimit(words)) {
        alert('You have exceeded the 100 words per hour limit.');
        return;
      }

      const timestamp = Date.now();
      db.ref("messages/" + timestamp).set({
        ip: ip,
        msg: message,
      }).then(() => {
        pruneMessages();
      });
      input.value = "";
    });

    const fetchChat = db.ref("messages/");
    fetchChat.on("child_added", snapshot => {
      const msg = snapshot.val();
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message", msg.ip === ip ? "sent" : "received");
      msgDiv.innerText = `${msg.ip}: ${msg.msg}`;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    function pruneMessages() {
      db.ref("messages/").once("value", snapshot => {
        if (snapshot.numChildren() > 1000) {
          const messages = [];
          snapshot.forEach(child => {
            messages.push({key: child.key, ts: parseInt(child.key)});
          });
          messages.sort((a, b) => a.ts - b.ts);
          const oldestKey = messages[0].key;
          db.ref("messages/" + oldestKey).remove();
        }
      });
    }

    function checkWordLimit(newWords) {
      let history = JSON.parse(localStorage.getItem('chatWordHistory') || '[]');
      const now = Date.now();
      history = history.filter(entry => now - entry.time < 3600000);
      const totalWords = history.reduce((sum, entry) => sum + entry.words, 0);
      if (totalWords + newWords > 100) return false;
      history.push({time: now, words: newWords});
      localStorage.setItem('chatWordHistory', JSON.stringify(history));
      return true;
    }
  </script>
</body>
</html>
